<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Stocks Cuisine</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui;background:#f6f7f9;margin:0}
header{background:#111827;color:#fff;padding:14px 18px;display:flex;align-items:center}
header b{font-size:16px}
nav a{color:#e5e7eb;margin-right:12px;text-decoration:none;font-size:13px}
nav a:hover{text-decoration:underline}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:12px}
.hidden{display:none}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,button{padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
button{background:#111827;color:#fff;border:none;cursor:pointer}
button.secondary{background:#374151}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
.muted{color:#6b7280;font-size:13px}
.pill{padding:4px 8px;border-radius:999px;font-size:12px}
.ok{background:#dcfce7;color:#166534}
.warn{background:#ffedd5;color:#9a3412}
.bad{background:#fee2e2;color:#991b1b}
img.prod{width:48px;height:48px;object-fit:contain;border:1px solid #eee;border-radius:6px;background:#fff}
</style>
</head>

<body>
<header>
<b>Stocks Cuisine</b>
<nav id="nav" class="hidden">
<a href="#products">Produits</a>
<a href="#reorder">À commander</a>
</nav>
<div style="margin-left:auto" id="userbox"></div>
</header>

<main>

<div class="card" id="loginCard">
<h3>Connexion</h3>
<div class="row">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Mot de passe">
<button id="loginBtn">Connexion</button>
</div>
<div id="loginMsg" class="muted"></div>
</div>

<div class="card hidden" id="appCard">
<div id="view"></div>
</div>

</main>

<script src="./config.js"></script>
<script>
const API = window.APP_CONFIG.API_BASE;
const qs=id=>document.getElementById(id);
const esc=s=>String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
let token=localStorage.getItem("token")||"";
let products=[];

async function api(path,opts={}){
const h={"Content-Type":"application/json"};
if(token)h.Authorization="Bearer "+token;
const r=await fetch(API+path,{...opts,headers:h});
const t=await r.text();
const d=JSON.parse(t||"{}");
if(!r.ok)throw d;
return d;
}

async function boot(){
if(!token)return;
try{
await api("/api/me");
qs("loginCard").classList.add("hidden");
qs("appCard").classList.remove("hidden");
qs("nav").classList.remove("hidden");
qs("userbox").innerHTML='<button class="secondary" onclick="logout()">Déconnexion</button>';
await loadProducts();
renderProducts();
}catch{logout();}
}

function logout(){
localStorage.removeItem("token");
location.reload();
}

qs("loginBtn").onclick=async()=>{
try{
qs("loginMsg").innerText="Connexion...";
const d=await api("/api/auth/login",{method:"POST",body:JSON.stringify({email:qs("email").value,password:qs("password").value})});
token=d.token;
localStorage.setItem("token",token);
boot();
}catch(e){qs("loginMsg").innerText="Erreur connexion";}
};

async function loadProducts(){
products=(await api("/api/products")).products;
}

function stockClass(p){
if(p.stock_current<=p.stock_min)return"bad";
if(p.stock_current<=p.stock_min*1.5)return"warn";
return"ok";
}

function renderProducts(){
qs("view").innerHTML=`
<h2>Produits</h2>

<div class="card">
<b>Ajouter un produit (copier / coller Adelya)</b>
<div class="row" style="margin-top:10px">
<input id="n" placeholder="Nom">
<input id="c" placeholder="Catégorie">
<input id="u" placeholder="Unité">
<input id="m" type="number" placeholder="Stock min">
<input id="l" placeholder="Emplacement">
<input id="img" placeholder="URL image">
<input id="link" placeholder="Lien fournisseur">
<button onclick="add()">Ajouter</button>
</div>
</div>

<div class="card">
<table>
<thead>
<tr><th>Produit</th><th>Stock</th><th>Min</th><th>Fournisseur</th></tr>
</thead>
<tbody>
${products.map(p=>`
<tr>
<td>
<div style="display:flex;gap:10px;align-items:center">
${p.image_url?`<img class="prod" src="${esc(p.image_url)}">`:""}
<div>
<b>${esc(p.name)}</b><br>
<span class="muted">${esc(p.category)}</span>
</div>
</div>
</td>
<td><span class="pill ${stockClass(p)}">${p.stock_current}</span></td>
<td>${p.stock_min}</td>
<td>${p.supplier_url?`<a href="${esc(p.supplier_url)}" target="_blank"><button class="secondary">Voir</button></a>`:""}</td>
</tr>
`).join("")}
</tbody>
</table>
</div>`;
}

async function add(){
await api("/api/products",{method:"POST",body:JSON.stringify({
name:qs("n").value,
category:qs("c").value,
unit:qs("u").value||"pcs",
stock_min:Number(qs("m").value||0),
location:qs("l").value,
image_url:qs("img").value,
supplier_url:qs("link").value
})});
await loadProducts();
renderProducts();
}

window.onhashchange=renderProducts;
boot();
</script>
</body>
</html>

